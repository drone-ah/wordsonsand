name: Despatch

on:
  push:
    branches:
      - blog/scheduled-posts-py
  schedule:
    - cron: "*/10 12-14 * * 1-5" # Every 10 minutes from 12:00 to 14:59 UTC (13:00â€“15:59 UK time)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  despatch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python 3.12.3
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.3"

      - name: Install Poetry 2.x
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache Poetry virtualenv
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: poetry-${{ runner.os }}-${{ hashFiles('tools/despatcher/poetry.lock') }}
          restore-keys: |
            poetry-${{ runner.os }}-

      - name: Install dependencies
        working-directory: tools/despatcher
        run: poetry install --no-root

      - name: Run despatcher script
        working-directory: tools/despatcher
        run: poetry run ./despatch.py ../../despatches/

      - name: Commit and push if changed
        run: |
          git config user.name "drone-ah bot"
          git config user.email "github.actions@drone-ah.com"

          if ! git diff --quiet; then
            git add -u
            git commit -m "auto: log post submissions"
            git push
          else
            echo "No changes to commit"
          fi
