{{- $u := urls.Parse .Destination -}}
{{- $text := .Text | safeHTML -}}

{{- if strings.HasPrefix $u.String "#" -}}
  <a href="{{ printf "%s#%s" .PageInner.RelPermalink $u.Fragment | safeURL }}" {{ with .Title }}title="{{ . }}"{{ end }}>{{ $text }}</a>

{{- else if not $u.IsAbs -}}
  {{- $path := strings.TrimPrefix "./" $u.Path -}}
  {{- $page := or
      ($.PageInner.GetPage $path)
      ($.PageInner.Resources.Get $path)
      (resources.Get $path)
  -}}

  {{- if and $page (not ($page.PublishDate.After now)) -}}
    {{- if eq $page.Type "youtube" -}}
      {{- $href := printf "https://www.youtube.com/watch?v=%s" $page.Params.youtubeId -}}
      {{- with $page.Params.playlist }}
        {{- $href = printf "%s&list=%s" $href . -}}
      {{- end }}
      <a href="{{ $href | safeURL }}" {{ with .Title }}title="{{ . }}"{{ end }}>{{ $text }}</a>
    {{- else -}}
      <a href="{{ $page.RelPermalink | safeURL }}" {{ with .Title }}title="{{ . }}"{{ end }}>{{ $text }}</a>
    {{- end }}
  {{- else -}}
    <span class="unpublished">{{ $text }}</span>
  {{- end }}

{{- else -}}
  <a href="{{ .Destination | safeURL }}" {{ with .Title }}title="{{ . }}"{{ end }}>{{ $text }}</a>
{{- end }}
