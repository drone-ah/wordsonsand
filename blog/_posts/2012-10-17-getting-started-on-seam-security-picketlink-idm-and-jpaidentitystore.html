---
layout: post
title: Getting started on seam-security, picketlink IDM and JPAIdentityStore
date: 2012-10-17 10:40:28.000000000 +01:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Java (EE)
tags:
- Identity management
- idm
- picketlink
- seam
- seam-security
- seam3
meta:
  _publicize_pending: '1'
  _edit_last: '48492462'
  oc_metadata: "{\t\tversion:'1.1',\t\ttags: {'seam': {\"text\":\"seam\",\"slug\":\"seam\",\"source\":null,\"bucketName\":\"current\",\"bucketPlacement\":\"auto\",\"_className\":\"Tag\"},
    'seam3': {\"text\":\"seam3\",\"slug\":\"seam3\",\"source\":null,\"bucketName\":\"current\",\"bucketPlacement\":\"auto\",\"_className\":\"Tag\"},
    'seam-security': {\"text\":\"seam-security\",\"slug\":\"seam-security\",\"source\":null,\"bucketName\":\"current\",\"bucketPlacement\":\"auto\",\"_className\":\"Tag\"},
    'picketlink': {\"text\":\"picketlink\",\"slug\":\"picketlink\",\"source\":null,\"bucketName\":\"current\",\"bucketPlacement\":\"auto\",\"_className\":\"Tag\"},
    'idm': {\"text\":\"idm\",\"slug\":\"idm\",\"source\":null,\"bucketName\":\"current\",\"bucketPlacement\":\"auto\",\"_className\":\"Tag\"},
    'identity-management': {\"text\":\"Identity management\",\"slug\":\"identity-management\",\"source\":null,\"bucketName\":\"current\",\"bucketPlacement\":\"auto\",\"_className\":\"Tag\"}}\t}"
  oc_commit_id: http://drone-ah.com/2012/10/17/getting-started-on-seam-security-picketlink-idm-and-jpaidentitystore/1350466831
  restapi_import_id: 591d994f7aad5
  original_post_id: '886'
  _wp_old_slug: '886'
  _last_editor_used_jetpack: block-editor
  _elasticsearch_data_sharing_indexed_on: '2024-11-18 14:54:56'
permalink: "/2012/10/17/getting-started-on-seam-security-picketlink-idm-and-jpaidentitystore/"
---
<p><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><br />
<html><body></p>
<p>I love how JBoss 7(.1) has everything working out of the box - not much fiddling with jars or suchlike and with Arquillian, everything really was a treat to get started on a new project. This was until I had to sort out security with seam-security.</p>
<p>To be fair, the main issue was just poor documentation. It took me a day to sort out what should essentially have taken an hour(or two)</p>
<p>The documentation you get to from <a href="http://www.seamframework.org/Seam3/SecurityModule">http://www.seamframework.org/Seam3/SecurityModule</a> seems to be out of date. The fact that the page referes to version 3.0.0.Alpha1 and Alpha2 should have tipped me off but the url for the doc suggested it was the latest.</p>
<p>The more up to date documentation I found was at <a href="http://docs.jboss.org/seam/3/3.1.0.Final/reference/en-US/html/pt04.html">http://docs.jboss.org/seam/3/3.1.0.Final/reference/en-US/html/pt04.html</a></p>
<p>I followed <a title="Identity Management" href="http://docs.jboss.org/seam/3/3.1.0.Final/reference/en-US/html/security-identitymanagement.html">chapter 33</a> on there and I won't repeat it here for the sake of brevity.</p>
<p>What follows are the additional steps I had to take to get it to work.</p>
<p><!--more--></p>
<p>I ran into a javax.enterprise.inject.CreationException, the relevant part of the stack trace being:</p>
<pre>Caused by: java.lang.IllegalArgumentException: targetClass parameter may not be null
	at org.jboss.solder.properties.query.PropertyQuery.(PropertyQuery.java:54) [solder-impl-3.1.0.Final.jar:3.1.0.Final]
	at org.jboss.solder.properties.query.PropertyQueries.createQuery(PropertyQueries.java:39) [solder-impl-3.1.0.Final.jar:3.1.0.Final]
	at org.jboss.seam.security.management.picketlink.JpaIdentityStore.findNamedProperty(JpaIdentityStore.java:441) [seam-security-3.1.0.Final.jar:3.1.0.Final]
	at org.jboss.seam.security.management.picketlink.JpaIdentityStore.configureRoleTypeName(JpaIdentityStore.java:877) [seam-security-3.1.0.Final.jar:3.1.0.Final]
	at org.jboss.seam.security.management.picketlink.JpaIdentityStore.bootstrap(JpaIdentityStore.java:328) [seam-security-3.1.0.Final.jar:3.1.0.Final]
	at org.picketlink.idm.impl.configuration.IdentityConfigurationImpl.createRealmMap(IdentityConfigurationImpl.java:192) [picketlink-idm-core-1.5.0.Alpha02.jar:1.5.0.Alpha02]
	at org.picketlink.idm.impl.configuration.IdentityConfigurationImpl.buildIdentitySessionFactory(IdentityConfigurationImpl.java:147) [picketlink-idm-core-1.5.0.Alpha02.jar:1.5.0.Alpha02]
	... 109 more</pre>
<p>To resolve this,  I had to add in the @IdentityEntity Annotation to the IdentityObjectType class</p>
<pre>@Entity
@IdentityEntity(EntityType.IDENTITY_ROLE_NAME)
public class IdentityObjectType {
...</pre>
<p>The next exception was org.picketlink.idm.common.exception.IdentityException: Error creating identity object. The relevant part of the strack trace being:</p>
<pre>Caused by: java.lang.NullPointerException
	at org.jboss.seam.security.management.picketlink.JpaIdentityStore.lookupIdentityType(JpaIdentityStore.java:966) [seam-security-3.1.0.Final.jar:3.1.0.Final]
	at org.jboss.seam.security.management.picketlink.JpaIdentityStore.createIdentityObject(JpaIdentityStore.java:999) [seam-security-3.1.0.Final.jar:3.1.0.Final]
	... 87 more</pre>
<p>It turned out that the entitymanager was not being picked up and it was null. This part was probably in the documentation earlier with regards to configuring seam but I had skipped directly to the security section so missed it. We need to define the persistence unit with the beans.xml. I have included my full file below.</p>
<pre>&lt;?xml version="1.0"?&gt;
&lt;beans xmlns="http://java.sun.com/xml/ns/javaee"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:em="urn:java:javax.persistence"
	xmlns:s="urn:java:ee"
	xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://jboss.org/schema/cdi/beans_1_0.xsd"&gt;

	&lt;interceptors&gt;
		&lt;class&gt;org.jboss.seam.security.SecurityInterceptor&lt;/class&gt;
	&lt;/interceptors&gt;

	&lt;em:EntityManager&gt;
		&lt;s:Produces /&gt;
		&lt;em:PersistenceContext unitName="invision-users" /&gt;
	&lt;/em:EntityManager&gt;
&lt;/beans&gt;</pre>
<p>This brought us further forward still. The next exception was:</p>
<pre>javax.persistence.NoResultException: No entity found for query
	at org.hibernate.ejb.QueryImpl.getSingleResult(QueryImpl.java:286) [hibernate-entitymanager-4.0.1.Final.jar:4.0.1.Final]
	at org.hibernate.ejb.criteria.CriteriaQueryCompiler$3.getSingleResult(CriteriaQueryCompiler.java:264) [hibernate-entitymanager-4.0.1.Final.jar:4.0.1.Final]
	at org.jboss.seam.security.management.picketlink.JpaIdentityStore.lookupCredentialTypeEntity(JpaIdentityStore.java:1112) [seam-security-3.1.0.Final.jar:3.1.0.Final]
	at org.jboss.seam.security.management.picketlink.JpaIdentityStore.updateCredential(JpaIdentityStore.java:1633) [seam-security-3.1.0.Final.jar:3.1.0.Final]
	at org.picketlink.idm.impl.repository.WrapperIdentityStoreRepository.updateCredential(WrapperIdentityStoreRepository.java:310) [picketlink-idm-core-1.5.0.Alpha02.jar:1.5.0.Alpha02]
	at org.picketlink.idm.impl.api.session.managers.AttributesManagerImpl.updatePassword(AttributesManagerImpl.java:563) [picketlink-idm-core-1.5.0.Alpha02.jar:1.5.0.Alpha02]</pre>
<p>This was related to missing data in the database. It needed a credential type. I created one for password.</p>
<pre>INSERT INTO CredentialType(id, name) VALUES (1, 'password');</pre>
<p>This brought us forward on to the next exception: org.picketlink.idm.common.exception.IdentityException: Exception creating relationship</p>
<p>with the relevant part of</p>
<pre>Caused by: javax.persistence.NoResultException: No entity found for query
	at org.hibernate.ejb.QueryImpl.getSingleResult(QueryImpl.java:286) [hibernate-entitymanager-4.0.1.Final.jar:4.0.1.Final]
	at org.hibernate.ejb.criteria.CriteriaQueryCompiler$3.getSingleResult(CriteriaQueryCompiler.java:264) [hibernate-entitymanager-4.0.1.Final.jar:4.0.1.Final]
	at org.jboss.seam.security.management.picketlink.JpaIdentityStore.lookupRelationshipType(JpaIdentityStore.java:1127) [seam-security-3.1.0.Final.jar:3.1.0.Final]
	at org.jboss.seam.security.management.picketlink.JpaIdentityStore.createRelationship(JpaIdentityStore.java:1066) [seam-security-3.1.0.Final.jar:3.1.0.Final]
	... 86 more</pre>
<p>This was solved by adding in a relationship type</p>
<pre>INSERT INTO RelationshipType(id, name) VALUES (1, 'JBOSS_IDENTITY_MEMBERSHIP');</pre>
<p>Both the sql statements were put into import.sql and hibernate is configured to create tables. My test case is as follows. It was taken from <a href="https://github.com/seam/seam-example-confbuzz/blob/develop/src/test/java/seam/example/confbuzz/test/integration/LoginIntegrationTest.java">https://github.com/seam/seam-example-confbuzz/blob/develop/src/test/java/seam/example/confbuzz/test/integration/LoginIntegrationTest.java</a> and modified.</p>
<pre>@RunWith(Arquillian.class)
public class LoginIntegrationTest {

	@Inject
	private IdentitySession identitySession;

	@Inject
	private Identity identity;

	@Inject
	@DefaultTransaction
	SeamTransaction tx;

	@Deployment(name = "authentication")
	public static Archive createLoginDeployment() {
		// This is the simplest way to test the full archive as you will be
		// deploying it
		final MavenDependencyResolver resolver =
				DependencyResolvers.use(MavenDependencyResolver.class)
					.loadMetadataFromPom("pom.xml")
					.goOffline();

		Archive archive = ShrinkWrap
				.create(WebArchive.class)
				.addPackages(true, "uk.co.kraya.test-seam.auth")
				.addAsResource("META-INF/test-persistence.xml", "META-INF/persistence.xml")
				.addAsResource("META-INF/beans.xml", "META-INF/beans.xml")
				.addAsResource("test-import.sql", "import.sql")
				.addAsLibraries(resolver.artifact("org.jboss.seam.security:seam-security").resolveAsFiles());

		System.out.println(archive.toString(true));

		return archive;

	}

	@Before
	public void setupTestUser() throws IdentityException, SystemException,
			NotSupportedException, RollbackException,
			HeuristicRollbackException, HeuristicMixedException {

		if (!tx.isActive())
			tx.begin();

		final PersistenceManager pm = identitySession.getPersistenceManager();
		final AttributesManager am = identitySession.getAttributesManager();
		final RelationshipManager rm = identitySession.getRelationshipManager();

		// Setup the group we want our user to belong to
		final Group memberGroup = pm.createGroup("member2", "USER2");
		final User user = pm.createUser("test");

		am.updatePassword(user, "password");

		rm.associateUser(memberGroup, user);

		tx.commit();
	}

	@Test
	public void assertUserCanAuthenticate(Credentials credentials) {
		credentials.setUsername("test");
		credentials.setCredential(new PasswordCredential("password"));
		assertEquals(identity.login(), Identity.RESPONSE_LOGIN_SUCCESS);
	}</pre>
<p>Do comment and let me know if it helped :-D</body></html></p>
