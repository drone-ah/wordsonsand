---
layout: post
title: Unable to write to $HOME/.pulumi/credentials.json during bazel test
date: 2023-11-14 13:46:46.000000000 +00:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories: []
tags:
- bazel
- Testing
meta:
  _last_editor_used_jetpack: block-editor
  _publicize_job_id: '89357332809'
  timeline_notification: '1699969607'
  wordads_ufa: s:wpcom-ufa-v4:1699969789
  _elasticsearch_data_sharing_indexed_on: '2024-11-18 14:55:05'
permalink: "/2023/11/14/unable-to-write-to-home-pulumi-credentials-json-during-bazel-test/"
---
<p><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><br />
<!-- wp:heading {"level":1} --><html><body></p>
<h1 class="wp-block-heading">The Problem</h1>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>You can add it to your ~/.bazelrc (it needs the path to be absolute)</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>From our integration tests, we run <code>pulumi stack output</code> (or in some cases <code>pulumi up</code>) through the automation API before we run the tests so that we can </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<!-- wp:list-item --></p>
<li>Confirm that the stack is up</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>Get the relevant parameters (actual names of lambdas / dynamo db tables etc.)</li>
<p><!-- /wp:list-item -->
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p>However, since we use bazel for our tests, we ran into a small problem in that Bazel (rightly) prevents the tests from writing to anything outside the sandbox. This restrictions results in this error</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:syntaxhighlighter/code --></p>
<pre class="wp-block-syntaxhighlighter-code">error: open /home/&lt;username&gt;/.pulumi/credentials.json: read-only file system</pre>
<p><!-- /wp:syntaxhighlighter/code --></p>
<p><!-- wp:more --><br />
<!--more--><br />
<!-- /wp:more --></p>
<p><!-- wp:heading {"level":1} --></p>
<h1 class="wp-block-heading">The Solution</h1>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>The easiest way to solve this is to ask <code>bazel</code> to allow writing to this location, which you can do with:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:syntaxhighlighter/code {"language":"bash"} --></p>
<pre class="wp-block-syntaxhighlighter-code">bazel test ... --sandbox_writable_path=$HOME/.pulumi</pre>
<p><!-- /wp:syntaxhighlighter/code --></p>
<p><!-- wp:paragraph --></p>
<p><code>bazel</code> needs to the path to be absolute, so <code>~/.pulumi</code> won't work.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":1} --></p>
<h1 class="wp-block-heading">Automation</h1>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>It is annoying to add this flag into all the tests, but there is an way to automatically add it to all tests. You can add it to <code>.bazelrc</code>. Due to the aforementioned requirement for the path to be absolute, it is not possible to put it into the git repo root. However, you can put it into your home directory rool <code>.bazelrc</code></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><code>$HOME/.bazelrc</code></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:syntaxhighlighter/code --></p>
<pre class="wp-block-syntaxhighlighter-code">test --sandbox_writable_path=/home/&lt;your-username&gt;/.pulumi</pre>
<p><!-- /wp:syntaxhighlighter/code --><br />
</body></html></p>
