---
layout: post
title: ZFS Deleting files doesn't free up space
date: 2018-04-12 10:15:02.000000000 +01:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Systems (Administration)
tags:
- SysAdmin
- Technology
- zfs
meta:
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '16719033684'
  timeline_notification: '1523528103'
  _elasticsearch_data_sharing_indexed_on: '2024-11-18 14:55:02'
permalink: "/2018/04/12/zfs-deleting-files-doesnt-free-up-space/"
---
<p><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><br />
<html><body></p>
<p>So I have a proxmox server on which I run a few VM's and the other day it completely ran out of space. This was because of overprovisioning through thin volumes.</p>
<p>After much head scratching and metaphorically banging my head against a wall, here are the things I learnt.</p>
<h2>Empty Trash</h2>
<h3>Local Trash</h3>
<p>Make sure that have emptied the trash on the VM's .Ubuntu has this issue and so might other distributions</p>
<h3>Network Trash</h3>
<p>If you have SAMBA enabled on your VM's make sure that the Recycle Bin is not enabled. I have openmediavault running on a VM and I had to go through and disable the Recycling Bin. Make sure that the Recycle bin is emptied. They are hidden folders in the root of your shares.</p>
<h2>Correct Driver &amp; Settings</h2>
<ul>
<li>When setting up the hard drive for your VM, make sure you use virtio-scsi (or just scsi on the web interface).
<ul>
<li>If you disk is already set up using IDE or VirtIO,
<ul>
<li>Delete it. Don't worry, it's only deleting the link. The disk itself will show up in the interface afterwards</li>
<li>Double click on the unattached disk and select SCSI and Discard</li>
<li>You might have to fix the references to the drive in the OS</li>
</ul>
</li>
</ul>
</li>
<li>On the Device Screen, make sure discard is selected.</li>
</ul>
<h2>TRIM</h2>
<p>Configure the OS to send TRIM commands to the drive</p>
<h3>Linux</h3>
<h4>On Mount</h4>
<p>You can pass the parameter discard to any mountpoint and the correct TRIM commands will be sent to the disk. <strong>HOWEVER</strong>, this is apparently a big performance hit.</p>
<p>To do the actual trim, run</p>
<p>[sourcecode language="csharp"]<br />
$ fstrim /<br />
[/sourcecode]</p>
<p>OR to run fstrimÂ on all supported drives</p>
<p>[sourcecode language="bash"]<br />
$ fstrim -a<br />
[/sourcecode]</p>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-configure-periodic-trim-for-ssd-storage-on-linux-servers">Digital Ocean has a detailed post about setting TRIM and setting up a schedule etc.</a></p>
<h3>Windows</h3>
<p>My deepest apologies! Also, I don't run Windows on any of my VM's so I have no experience with it.</body></html></p>
